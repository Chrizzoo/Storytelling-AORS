<?xml version="1.0" encoding="UTF-8"?>
<?xml-stylesheet type="text/xsl" href="prettyprint.xsl" ?>
<SimulationScenario scenarioName="Juveniles1" version="0.9" createSimulationLog="true"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns="http://aor-simulation.org" xmlns:aor="http://aor-simulation.org"
	xsi:schemaLocation="http://aor-simulation.org distribution/ext/aorsl/AORSL_0-9.xsd ">
	<SimulationParameters simulationSteps="1000" />
	<SimulationModel modelName="Juveniles1" modelTitle="Juveniles Scenario 1">
		<documentation>
			<dc:creator>Rene Groothedde</dc:creator>
			<dc:created>20130805</dc:created>
			<dc:contributor>Chris Broekema</dc:contributor>
		</documentation>
		<!-- ========================== -->
		<DataTypes>
			<ComplexDataType name="MessageContent"></ComplexDataType>
		</DataTypes>
		<!-- ========================== -->
		<Globals>
			<GlobalVariable name="POLICE_ID" dataType="Integer" initialValue="1" />
			<GlobalVariable name="JUVENILE_ID" dataType="Integer" initialValue="2" />
			<aor:GlobalVariable name="REACTION_DELAY" dataType="Integer" initialValue="30" />
			<GlobalVariable name="MessageLogString" dataType="String" initialValue=""></GlobalVariable>
			<GlobalFunction resultType="String" name="getAppendedLog">
				<Parameter name="message" type="String" />
				<Body language="Java">
				string result = Global.MessageLogString + "; " + message;
				result = result.substring(result.length()-100);
				simConsole.message(message);
				return result;
				</Body>
				<Body language="JavaScript">
				var result = Global.MessageLogString + "; " + message;
				var maxlength = 120;
				if (result.length > maxlength){
					result = "..."+ result.substring(result.length - maxlength);}
				simConsole.message(message);
				return result;
				</Body>
			</GlobalFunction>
		</Globals>
		<!-- ========================== -->
		<EntityTypes>
			<!-- ========================== -->
			
			<MessageType name="Tell">
				<Attribute name="senderName" type="String" />
				<!-- ========================== -->
				<Attribute name="content" type="String" />
				<!-- ========================== -->
				<Function resultType="String" name="toString">
					<Body language="Java JavaScript">return this.getSenderName() + ":\""+ this.getContent()+ "\"";</Body>
				</Function>
				<!-- ========================== -->
				<Function resultType="boolean" name="contentEquals">
					<Parameter name="msg" type="String" />
					<Body language="Java">return this.getContent().equals(msg);</Body>
					<Body language="JavaScript">return this.getContent() == msg; </Body>
				</Function>
				<!-- ========================== -->
			</MessageType>
			<!-- ========================== -->
			<CausedEventType name="AskInput" />
			
			<!-- ========================== -->
			<ActionEventType name="AddLogMessage">
				<Attribute name="msg" type="String" />
			</ActionEventType>
			<!-- ========================== -->
			<AgentType memorySize="5" name="Person">
				<Attribute name="lastMessage" type="String" initialValue="" />
				
				<ReferenceProperty name="MessageHistory" type="Tell"></ReferenceProperty>
				<!-- ========================== -->
				<ReactionRule name="LogIncommingMessage">
					<aor:documentation>
						<aor:description>test</aor:description>
					</aor:documentation>
					<WHEN eventType="InMessageEvent" eventVariable="evt" messageType="Tell" messageVariable="msg" />
					<DO>
						<SCHEDULE-EVT>
							<ActionEventExpr actionEventType="AddLogMessage">
								<Slot property="msg">
									<ValueExpr language="Java JavaScript" logPeriodicity="1">this.msg.toString()</ValueExpr>
								</Slot>
							</ActionEventExpr>
						</SCHEDULE-EVT>
					</DO>
				</ReactionRule>
			</AgentType>
			<!-- ==================================== -->
			<AgentType memorySize="5" name="Police" superType="Person">
				<ReactionRule name="AskInputForPolice" agentVariable="agt">
					<WHEN eventType="InMessageEvent" eventVariable="evtVar" messageType="Tell"
						messageVariable="msg" />
					<DO>
						<SCHEDULE-EVT>
							<ActionEventExpr actionEventType="AskInput" ><aor:Delay>
									<aor:GlobalVariableValueExpr variable="REACTION_DELAY" />
								</aor:Delay>
							</ActionEventExpr>
						</SCHEDULE-EVT>
					</DO>
				</ReactionRule>
				<!-- ========================== -->
				<ActionRule name="TellRule" agentVariable="agt">
					<RuleParameter name="msgContent" type="String" />
					<DO>
						<UPDATE-AGT>
							<Slot property="lastMessage">
								<ValueExpr logPeriodicity="5" language="Java JavaScript">this.msgContent</ValueExpr>
							</Slot>
						</UPDATE-AGT>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="Tell" >
								<ReceiverIdRef language="Java JavaScript">Global.JUVENILE_ID </ReceiverIdRef>
								<aor:Delay>
									<aor:GlobalVariableValueExpr variable="REACTION_DELAY" />
								</aor:Delay>
								<Slot property="senderName">
									<ValueExpr language="Java JavaScript">this.agt.getName()</ValueExpr>
								</Slot>
								<Slot property="content">
									<ValueExpr language="Java JavaScript">this.msgContent</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</DO>
				</ActionRule>
			</AgentType>
			<!-- ========================== -->
			<AgentType name="Juvenile" superType="Person" memorySize="5">
				<!-- =================================================== -->
				<ReactionRule name="AnwserGaWeg" agentVariable="agt">
					<WHEN eventType="InMessageEvent" eventVariable="evt" messageType="Tell" messageVariable="msg" />
					<IF language="Java JavaScript">this.msg.contentEquals("Ga weg") </IF>
					<THEN>
						<UPDATE-AGT >
							<Slot  property="lastMessage" value="Ga zelf weg" />
						</UPDATE-AGT>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="Tell">
								<ReceiverIdRef language="Java JavaScript">Global.POLICE_ID </ReceiverIdRef>
								<aor:Delay>
									<aor:GlobalVariableValueExpr variable="REACTION_DELAY" />
								</aor:Delay>
								<Slot property="senderName">
									<ValueExpr language="Java JavaScript">this.agt.getName()</ValueExpr>
								</Slot>
								<Slot property="content">
									<ValueExpr language="Java JavaScript">this.agt.getLastMessage()</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</ReactionRule>
				<!-- =================================================== -->
				<ReactionRule name="AnwserHoi" agentVariable="agt">
					<WHEN eventType="InMessageEvent" eventVariable="evt" messageType="Tell" messageVariable="msg" />
					<IF language="Java JavaScript">this.msg.contentEquals("Hoi") </IF>
					<THEN>
						<UPDATE-AGT>
							<Slot property="lastMessage" value="Hoi" />
						</UPDATE-AGT>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="Tell">
								<ReceiverIdRef language="Java JavaScript">Global.POLICE_ID </ReceiverIdRef>
								<aor:Delay>
									<aor:GlobalVariableValueExpr variable="REACTION_DELAY" />
								</aor:Delay>
								<Slot property="senderName">
									<ValueExpr language="Java JavaScript">this.agt.getName()</ValueExpr>
								</Slot>
								<Slot property="content">
									<ValueExpr language="Java JavaScript">this.agt.getLastMessage()</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</ReactionRule>
				<!-- =================================================== -->
				<ReactionRule name="AnwserWatDoeJeHier" agentVariable="agt">
					<WHEN eventType="InMessageEvent" eventVariable="evt" messageType="Tell" messageVariable="msg" />
					<IF language="Java JavaScript">this.msg.contentEquals("Wat doe je hier?") </IF>
					<THEN>
						<UPDATE-AGT>
							<Slot property="lastMessage" value="Gewoon staan" />
						</UPDATE-AGT>
						<SCHEDULE-EVT>
							<OutMessageEventExpr messageType="Tell">
								<ReceiverIdRef language="Java JavaScript">Global.POLICE_ID </ReceiverIdRef>
								<aor:Delay>
									<aor:GlobalVariableValueExpr variable="REACTION_DELAY" />
								</aor:Delay>
								<Slot property="senderName">
									<ValueExpr language="Java JavaScript">this.agt.getName()</ValueExpr>
								</Slot>
								<Slot property="content">
									<ValueExpr language="Java JavaScript">this.agt.getLastMessage()</ValueExpr>
								</Slot>
							</OutMessageEventExpr>
						</SCHEDULE-EVT>
					</THEN>
				</ReactionRule>
			</AgentType>
		</EntityTypes>
		<!-- =================================================== -->
		<EnvironmentRules>
			<!-- =================================================== -->
			<EnvironmentRule name="AddLogMessageRule">
				<WHEN eventType="AddLogMessage" eventVariable="evt" />
				<DO>
					<UPDATE-ENV>
						<UpdateGlobalVariable name="MessageLogString">
							<ValueExpr language="Java JavaScript">Global.getAppendedLog(this.evt.getMsg())</ValueExpr>
						</UpdateGlobalVariable>
					</UPDATE-ENV>
				</DO>
			</EnvironmentRule>
			<!-- =================================================== -->
		</EnvironmentRules>
		<!-- =================================================== -->
	</SimulationModel>
	<!-- =================================================== -->
	<InitialState>
		<GlobalVariable name="POLICE_ID" value="1" />
		<GlobalVariable name="JUVENILE_ID" value="2" />
		<Agent type="Police" name="Henk" id="1" objectVariable="police" />
		<Agent type="Juvenile" name="Harry" id="2" objectVariable="juvenile" />
		<CausedEvent occurrenceTime="1" type="AskInput"></CausedEvent>
	</InitialState>
	<!-- =================================================== -->
	<UserInterface supportedLanguages="en">
		<AnimationUI>
			<Views>
				<SpaceView canvasColor="darkgrey">
					<TwoDimensionalSpaceView2D backgroundColor="white" />
				</SpaceView>
				<!-- =================================================== -->
				<ObjectView objectType="Juvenile" displayName="true">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<Shape2D x="70%" y="50%">
						<Rectangle texture="juvenile.png" positioning="CenterTop" height="30px" width="30px" />
					</Shape2D>
					<aor:DisplayInfo property="lastMessage" />
				</ObjectView>
				<!-- =================================================== -->
				<ObjectView objectType="Police" displayName="true">
					<!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
					<Shape2D x="30%" y="50%">
						<Rectangle texture="agent.png" positioning="CenterTop" height="30px" width="30px"></Rectangle>
					</Shape2D>
					<aor:DisplayInfo property="lastMessage"/>
				</ObjectView>
			</Views>
			<!-- =================================================== -->
			<AgentControlUI waitForUserInput="true" initiallyPlayedAgent="Henk">
				<AgentControlByAgentType cssFile="https://github.com/Chrizzoo/Storytelling-AORS/blob/master/custom.css"
					type="Police">
					<!-- =================================================== -->
					<TopOutputPanel>
						<OutputFieldGroup>
							<OutputField label="Log:">
								<Source>
									<GlobalVariable name="MessageLogString" />
								</Source>
							</OutputField>
						</OutputFieldGroup>
					</TopOutputPanel>
					<!-- =================================================== -->
					<RightOutputPanel width="1">
						<EventList>
							<InMessageEventView label="Bericht" messageType="Tell" keepInListTime="10">
								<MessageProperty name="senderName" label="Persoon"></MessageProperty>
								<MessageProperty name="content" label="zegt" />
							</InMessageEventView>
						</EventList>
					</RightOutputPanel>
					<!-- =================================================== -->
					<MultiChoiceUserActionForm actionRuleParameter="msgContent"
						actionRule="TellRule" positioning="CenterBottom" enabledWhenEventOfType="AskInput">
						<Options>
							<Option value="Ga weg" default="true">
								<Text>Ga weg</Text>
							</Option>
							<Option value="Hoi">
								<Text>Hoi</Text>
							</Option>
							<Option value="Wat doe je hier?">
								<Text>Wat doe je hier?</Text>
							</Option>
						</Options>
					</MultiChoiceUserActionForm>
				</AgentControlByAgentType>
			</AgentControlUI>
		</AnimationUI>
	</UserInterface>
</SimulationScenario>